!function(){L.Handler.MarkerPin=L.Handler.extend({options:{distance:20,vertices:!0},initialize:function(i,t,n){L.Handler.prototype.initialize.call(this,i),L.Util.setOptions(this,n||{})},enable:function(i){i&&this._map.options.pin&&(this._observeMarker(i),this._currentMarker=i)},disable:function(){this._map.options.pin&&this._unobserveMarker()},_observeMarker:function(i){function t(i){if(void 0!==i._layers)for(var e in i._layers)i._layers.hasOwnProperty(e)&&t(i._layers[e]);else n.push(_.cloneDeep(i))}i.on("move",this._updateLatLng,this);for(var n=[],e=0;e<this._map._guides.length;e++){var s=this._map._guides[e];t(s)}this._guideList=n},_unobserveMarker:function(){this._currentMarker.off("move",this._updateLatLng,this)},_updateLatLng:function(i){var t=i.target;t.setOpacity(1),L.DomUtil.addClass(t._icon,"leaflet-marker-icon leaflet-div-icon leaflet-editing-icon leaflet-pin-marker");var n=t.getLatLng();this._closest=this._findClosestMarker(this._map,this._guideList,n,this.options.distance,this.options.vertices),null!=this._closest&&(t._latlng=this._closest.latlng,t.update())},_findClosestMarker:function(i,t,n,e,s){return L.GeometryUtil.closestLayerSnap(i,t,n,e,s)}}),L.Map.Pin={_pin_initialize:function(){this._guides=[];for(var i=0;i<this.options.guideLayers.length;i++)this.addGuideLayer(this.options.guideLayers[i]);this.options.pinControl&&this.addControl(new L.Control.Pin)},togglePin:function(){this.options.pin=!this.options.pin},addGuideLayer:function(i){this._guides.push(i)}},L.Map.include(L.Map.Pin),L.Map.addInitHook("_pin_initialize"),L.Map.mergeOptions({pin:!1,pinControl:!1,guideLayers:[]}),L.Draw.Feature.Pin={_pin_initialize:function(){this.on("enabled",this._pin_on_enabled,this),this.on("disabled",this._pin_on_disabled,this)},_pin_on_enabled:function(){var i=this._mouseMarker;this._pinning||(this._pinning=new L.Handler.MarkerPin(this._map)),this.options.vertices&&(this._pinning.options.vertices=this.options.vertices),this.options.distance&&(this._pinning.options.distance=this.options.distance),this._pinning.enable(i),i.on("click",this._pin_on_click,this)},_pin_on_click:function(i){if(this._markers){var t=this._markers.length,n=this._markers[t-1];if(i&&(n.setLatLng(i.target._latlng),this._poly)){var e=this._poly._latlngs.length;this._poly._latlngs[e-1]=i.target._latlng,this._poly.redraw()}}},_pin_on_disabled:function(){delete this._pinning}},L.Edit.Marker.Pin={_pin_initialize:function(){this._marker.on("dragstart",this._pin_on_dragstart,this),this._marker.on("dragend",this._pin_on_dragend,this)},_pin_on_dragstart:function(i){this._marker._pinning||(this._marker._pinning=new L.Handler.MarkerPin(this._marker._map)),this._marker._pinning.enable(this._marker)},_pin_on_dragend:function(i){this._marker._pinning.disable(this._marker)}},L.Edit.Marker.include(L.Edit.Marker.Pin),L.Edit.Marker.addInitHook("_pin_initialize"),L.Draw.Feature.include(L.Draw.Feature.Pin),L.Draw.Feature.addInitHook("_pin_initialize"),L.Control.Pin=L.Control.extend({options:{position:"topleft"},onAdd:function(i){return this._container=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-pin"),this._createButton(),this._updateButton(),this._container},_createButton:function(){var i=L.DomUtil.create("a","",this._container);L.DomEvent.on(i,"click",this._togglePin,this)},_togglePin:function(){this._map.togglePin(),this._updateButton()},_updateButton:function(){var i="leaflet-control-pin-enabled";this._map.options.pin?L.DomUtil.addClass(this._container,i):L.DomUtil.removeClass(this._container,i)}})}();